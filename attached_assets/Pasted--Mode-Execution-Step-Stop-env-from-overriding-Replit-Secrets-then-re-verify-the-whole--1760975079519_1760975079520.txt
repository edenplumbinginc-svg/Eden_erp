[Mode: Execution]

**Step:** Stop `.env` from overriding Replit Secrets, then re-verify the whole stack (guards, session pooler, TLS, smoke).

**Why it matters:** Your `.env` was winning due to `override:true`, keeping you on aws-1 with the old password. We’ll make runtime env (Replit Secrets) the source of truth and kill the loop for good.

**Inputs needed:**

* Repo access (edit `.env` and the dotenv loader in code)
* Replit Secrets already set to **aws-0** + **new password**

**Command (copy–paste all):**

```bash
# 1) Comment out local DATABASE_URL so it never beats Replit Secrets
sed -i 's/^DATABASE_URL=/# DATABASE_URL=/' .env && echo "✅ Commented DATABASE_URL in .env"

# 2) Ensure dotenv does NOT override runtime env
#    Find any "override:true" usage and remove it
grep -RIn "dotenv" . || true
grep -RIn "override\s*:\s*true" . && \
  sed -i 's/{\s*override:\s*true\s*}/{}/g' $(grep -RIl "override\s*:\s*true" .) || true

# If you have a central env loader, enforce this pattern:
#   require('dotenv').config(); // no override
# Or only load in non-production:
#   if (process.env.NODE_ENV !== 'production') require('dotenv').config();

# 3) (Optional) Prevent local edits from re-breaking env precedence
git add .gitignore 2>/dev/null || true
grep -qE '^\s*\.env(\.|$|$)' .gitignore || echo ".env" >> .gitignore
git update-index --assume-unchanged .env 2>/dev/null || true

# 4) Reboot and fingerprint
pkill -f "node server" 2>/dev/null || true
npm run verify:db
node server.js > /tmp/server.log 2>&1 & sleep 3
curl -s http://localhost:3000/api/debug/dbinfo | jq .

# 5) Prove SSL + session pooler + new password works
psql "$DATABASE_URL" -X -c "show ssl;"
psql "$DATABASE_URL" -X -c "select inet_server_addr() as db_ip, current_user as db_user, current_database() as db;"

# 6) Full transactional smoke
bash -lc './prod-smoke.sh'
```

**Success check:**

* `verify:db` **passes**.
* `/api/debug/dbinfo` shows **pooler_type: "session"**, host **aws-0-us-east-2.pooler.supabase.com:5432**, ref **jwehjdggkskmjrmoqibk**.
* `show ssl;` returns **on**.
* Smoke ends with **✅✅✅ PASS**.
* `/tmp/server.log` has **no** lines mentioning `aws-1` or dotenv override.

**Next:** wait for user
