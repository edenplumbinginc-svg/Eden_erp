[Layer: Planningâ†’APIâ†’Frontendâ†’RBACâ†’Flags] [Stage: Close slice gap â€” add ğŸ™ï¸ badge]

You shipped a lot. But by our AC, the Task List badge is still missing. Vertical slice isnâ€™t â€œdoneâ€ until thatâ€™s in or AC is amended. Easiest path: add a voiceNotesCount to the tasks list API and render a gated badge.

Patch plan (internal-only, fast)

API layer (routes/tasks.js â€” list endpoint)
Add the count column:

-- In your SELECT for GET /api/tasks (alias task table as t)
(SELECT COUNT(*)::int FROM task_voice_notes vn WHERE vn.task_id = t.id) AS voice_notes_count


Return it in each task item (voiceNotesCount in JSON). No schema change.

RBAC
No new rule needed for the count, but in the UI we will only show the badge if the user has tasks.voice.read and the feature flag is ON.

Frontend: Task item badge
In apps/coordination_ui/src/components/TaskItem.jsx (or wherever each task row renders):

import FeatureGate from "../components/FeatureGate";
import RequirePermission from "../components/RequirePermission";

// inside the row header/metadata area:
<FeatureGate feature="voiceToText">
  <RequirePermission resource="voice" action="read" fallback={null}>
    {task.voiceNotesCount > 0 && (
      <span title="Voice notes present" className="ml-2 inline-flex items-center text-xs border rounded px-1.5 py-0.5">
        ğŸ™ï¸ {task.voiceNotesCount}
      </span>
    )}
  </RequirePermission>
</FeatureGate>


Ensure your task-fetch hook preserves the new voiceNotesCount field.

Feature flag
features.json continues with "voiceToText": false by default. Turn ON only to test internally.

Smoke (copyâ€“paste)

1) API returns count

curl -s 'http://localhost:3000/api/tasks?limit=5' \
 -H 'X-Dev-User-Email: test@edenplumbing.com' \
 -H 'X-Dev-User-Id: 855546bf-f53d-4538-b8d5-cd30f5c157a2' \
 -H 'X-Dev-Role: Admin' | jq '.items[] | {id, voiceNotesCount}'


Expect integers â‰¥0.

2) UI badge rules

Flag OFF â†’ no badge anywhere.

Flag ON, role Admin (has tasks.voice.read) â†’ rows with voiceNotesCount>0 show ğŸ™ï¸ N.

Flag ON, role Viewer without tasks.voice.read â†’ badge hidden even if count > 0.

Commit hints

feat(api): include voiceNotesCount in GET /tasks

feat(frontend): ğŸ™ï¸ badge on TaskItem (flag+RBAC guarded)

docs: update VOICE_NOTES.md (badge behavior + RBAC)

DoD delta to mark slice COMPLETE

 Tasks list shows ğŸ™ï¸ badge when voiceNotesCount>0 (flag ON + tasks.voice.read).

 GET /api/tasks returns voiceNotesCount.

 Smoke screenshots: list with/without badge; Viewer role (hidden).

 CHANGELOG updated; Notion slice â†’ Shipped.

Mini-lesson: badges are â€œexistence leaksâ€ if ungated. We gate by flag + tasks.voice.read, so unauthorized users neither see nor infer the presence of audio. Defense-in-depth stays intact.