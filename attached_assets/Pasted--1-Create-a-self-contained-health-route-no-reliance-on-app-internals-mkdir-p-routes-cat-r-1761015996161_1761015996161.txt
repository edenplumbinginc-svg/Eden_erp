# 1) Create a self-contained health route (no reliance on app internals)
mkdir -p routes

cat > routes/healthz.js <<'JS'
import { Client } from "pg";

export async function healthz(req, res) {
  const started = Date.now();

  // Strict TLS by default; flip to relaxed only if you set HEALTH_TLS_RELAX=1
  const strict = process.env.HEALTH_TLS_RELAX !== "1";
  const ssl = strict ? { rejectUnauthorized: true } : { rejectUnauthorized: false };

  const client = new Client({ connectionString: process.env.DATABASE_URL, ssl });
  try {
    await client.connect();
    const r = await client.query("select 1 as ok, now() as ts");
    const ms = Date.now() - started;
    return res.status(200).json({
      status: "ok",
      db: "up",
      tls: strict ? "strict" : "relaxed",
      latency_ms: ms,
      ts: r.rows[0].ts
    });
  } catch (e) {
    const ms = Date.now() - started;
    return res.status(503).json({
      status: "degraded",
      db: "error",
      tls: strict ? "strict" : "relaxed",
      latency_ms: ms,
      error: e.message
    });
  } finally {
    try { await client.end(); } catch {}
  }
}
JS

# 2) Wire it into your server (idempotent; adds once)
# This assumes your entry point is server.js or index.js and uses Express.
# If your file is named differently, replace server.js below.
if grep -q "from \"express\"" server.js 2>/dev/null || grep -q "require('express')" server.js 2>/dev/null; then
  :
else
  echo "⚠️  Couldn't find server.js with Express import. If your entry is index.js/app.js, tell me the filename and I'll patch it."
fi

# Append minimal glue if not present already
awk '1;/__HEALTHZ_ANCHOR__/ {exit}' server.js >/dev/null 2>&1 || cat >> server.js <<'JS'

// __HEALTHZ_ANCHOR__
import express from "express";
import { healthz } from "./routes/healthz.js";

const app = globalThis.app || express(); // reuse if already created
app.get("/healthz", healthz);

// Expose app for older setups that start the server elsewhere
globalThis.app = app;
JS

# 3) Restart and test
killall node 2>/dev/null || true
node . & sleep 1
curl -sS http://localhost:3000/healthz | sed 's/\"ts\":\"[^\"]*\"/\"ts\":\"…\"/'
